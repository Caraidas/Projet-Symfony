{% extends 'base.html.twig' %}
{% block title %}{{ webtoon.titre }}{% endblock %}

{% block body %}
    {% if app.user and webtoon.user == app.user and isAuthor %}
        <a href="{{ path('episode_form', { slug: webtoon.slug }) }}" class="menu-btn"   >
            ➕ Ajouter un épisode
        </a>
        <a href="{{ path('episode_edit_form', { slug: webtoon.slug }) }}" class="menu-btn">
            ✏️ Modifier un épisode
        </a>
        <a href="{{ path('webtoon_edit', { slug: webtoon.slug }) }}" class="menu-btn">
            ✏️ Modifier Webtoon
        </a>
    {% endif %}
    {% if app.user %}
        {% set liked = false %}
        {% for like in webtoon.likes %}
            {% if like.user == app.user %}
                {% set liked = true %}
            {% endif %}
        {% endfor %}

        <form method="post" action="{{ path('webtoon_like', {id: webtoon.id}) }}">
            <button type="submit" class="menu-btn">
                {{ liked ? 'Je n’aime plus ❤️' : 'J’aime ❤️' }}
            </button>
        </form>
        <form action="{{ path('toggle_favori', { id: webtoon.id }) }}" method="post">
            <button type="submit"  class="menu-btn">
                {% if app.user.favoris.contains(webtoon) %}
                    Retirer des favoris
                {% else %}
                    Ajouter aux favoris
                {% endif %}
            </button>
        </form>
    {% else %}
        <p><a href="{{ path('app_login') }}">Connecte-toi pour aimer ce webtoon</a></p>
    {% endif %}
    <p>{{ webtoon.likes|length }} ❤️</p>

    

    <h1>{{ webtoon.titre }}</h1>
    <p>{{ webtoon.description }}</p>

    <div class="webtoon-container">
        <div class="webtoon-card-wrapper">
            {% if webtoon.image %}
                <img src="{{ asset('images/' ~ webtoon.image) }}" alt="{{ webtoon.titre }}" width="300">
            {% else %}
                <img src="{{ asset('images/Default.png') }}" alt="Image par défaut" width="300">
            {% endif %}
        </div>

        <p><strong>Auteur :</strong> {{ webtoon.user.pseudo }}</p>

        <div class="episode-list">
            {% if episodes|length > 0 %}
                <ul>
                    {% for episode in episodes %}
                        <li>
                            <a href="{{ path('episode_detail', { slug: webtoon.slug, number: episode.number }) }}">
                                Voir l’épisode {{ episode.number }} : {{ episode.title }}
                            </a>
                            <p>{{ episode.createdAt|date('d/m/Y') }}</p> 
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Aucun épisode pour le moment.</p>
            {% endif %}
        </div>
    </div>

    <h2>Commentaires</h2>

    {# Formulaire d'ajout de commentaire #}
    {% if app.user %}
        <div class="comment-box">
            {{ form_start(form) }}
                {{ form_row(form.message) }}
                <button type="submit" class="send-btn">➤</button>
            {{ form_end(form) }}
        </div>
    {% else %}
        <p><a href="{{ path('app_login') }}">Connecte-toi</a> pour commenter ce webtoon.</p>
    {% endif %}

    {# Liste des commentaires #}
    <div>
        {% for commentaire in commentaires %}
            <div style="margin-bottom: 1rem; padding: 0.5rem; border-bottom: 1px solid #ccc;">
                <strong>{{ commentaire.user.pseudo }}</strong><br>
                <p>{{ commentaire.message }}</p>
            </div>
        {% else %}
            <p>Soyez le premier à commenter ce Webtoon !</p>
        {% endfor %}
    </div>

{% endblock %}
